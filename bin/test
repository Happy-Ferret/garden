#!/bin/bash
# vim: set ft=sh

set -e -x

FIRST_GOPATH=`echo $GOPATH | cut -d':' -f1`

export PATH=$FIRST_GOPATH/bin:$PATH

go get -v github.com/vito/gocart

gocart
go install github.com/onsi/ginkgo/ginkgo
go install code.google.com/p/go.tools/cmd/cover
go install github.com/dustin/goveralls

ginkgo -cover -race -r -i -skipMeasurements -randomizeAllSpecs "$@"

echo mode: set > all.coverprofile
for profile in $(ls *.coverprofile | grep -v fake); do
  cat $profile | grep -v mode: >> all.coverprofile
done

# don't leak coveralls token
(
  set +x
  goveralls -coverprofile=all.coverprofile $COVERALLS_TOKEN
)
